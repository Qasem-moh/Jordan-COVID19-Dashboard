{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}

{% block head_scripts %}
    <!-- LeafletJS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
    <script type="text/javascript" src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/shp.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/catiline.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/leaflet.shpfile.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/geostats.min.js') }}"></script>

    <style type="text/css">
        .legend {
            background-color: white;
            padding: 10px;
            line-height: 18px;
            color: #555;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
    </style>
{% endblock %}

{% block outer_content %}
    <h1><strong>COVID-19 Cases in Jordan</strong></h1>
    <p class="lead font-weight-normal">Newly reported COVID-19 cases for <span id="selectedDate"></span></p>

    <div id="map" style="width: 100%; height: 500px;"></div>

    <hr>
    <h5><strong>Map Controls</strong></h5>

    <form>
        <div class="row">
            <div class="col-md-6">
                <!-- View date selector form -->
                <div class="form-group">
                    <label for="viewDateSelect"><strong>Select a date to view</strong></label>
                    <select class="form-control" id="viewDateSelect">
                        {% for url in all_urls %}
                            <option value="{{ url[0] }}">{{ url[1].strftime('%B %d %Y') }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-6" style="border-left: 1px solid lightgray;  padding-left: 10px">
                <div class="form-group">
                    <label for="dataClassificationMethodSelect"><strong>Select data classification method</strong></label>
                    <select class="form-control" id="dataClassificationMethodSelect">
                        <option value="jenks" selected>Natural Breaks (Jenks)</option>
                        <option value="eqinterval">Equal Interval</option>
                        <option value="quantile">Quantile</option>
                    </select>
                </div>

                <br>

                <!-- Toggle controls -->
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="toggleLocalPopulationRatio">
                    <label class="form-check-label" for="toggleLocalPopulationRatio">
                        Show number of cases proportional to local population
                    </label>
                </div>
                <hr>
                <a href="#" onclick="downloadCSV()" class="btn btn-success">Download data as CSV</a>
            </div>
        </div>
    </form>
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        //-------------------------------------------------------------------------------
        // jQuery event handlers
        //-------------------------------------------------------------------------------

        // On page load events
        $(document).ready(function () {
            mapOptionChangedHandler();
        });

        // "Select a date to view" changed event handler
        $("#viewDateSelect").change(function () {
            mapOptionChangedHandler();
        });

        // "Show number of cases proportional to local population" changed event handler
        $("#toggleLocalPopulationRatio").change(function () {
            mapOptionChangedHandler();
            console.log($(this).is(':checked'))
        });

        // "Select data classification method" changed event handler
        $("#dataClassificationMethodSelect").change(function () {
            mapOptionChangedHandler();
        })

        //-------------------------------------------------------------------------------
        // LeafletJS
        //-------------------------------------------------------------------------------

        const NUM_CLASSES = 7;
        let shpFile;
        let selectedDateCasesData;
        let classes;

        // Initialize map
        let map = L.map('map').setView([31.25, 36.5], 7);

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);

        //-------------------------------------------------------------------------------

        /**
         * Determines the appropriate hex color code for the different data classes
         */
        function getColor(val) {
            // Apply the color grading to the different classes
            if (val >= classes[7]) {
                return "#800026";
            } else if (val >= classes[6]) {
                return "#BD0026";
            } else if (val >= classes[5]) {
                return "#E31A1C";
            } else if (val >= classes[4]) {
                return "#FC4E2A";
            } else if (val >= classes[3]) {
                return "#FD8D3C";
            } else if (val >= classes[2]) {
                return "#FEB24C";
            } else if (val >= classes[1]) {
                return "#FED976";
            } else if (val >= classes[0]) {
                return "#FFEDA0";
            } else {
                return "#fff5e9";
            }
        }

        /**
         * Applies the appropriate styling to the passed region based on the number of COVID-19 cases
         */
        function style(feature) {
            // Get the number of COVID-19 cases for selected date
            feature.properties['Number of Cases'] = selectedDateCasesData[feature.properties['RegionName']];

            return {
                fillColor: getColor(feature.properties["Number of Cases"]),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        /**
         * Handler for view data selector change
         */
        function mapOptionChangedHandler() {
            // Try to remove existing map layer
            try {
                map.removeLayer(shpFile);
            } catch (e) {
                console.log("Unable to remove shapefile layer. It may have already been removed or there was an error")
            }

            // Get the case data for the selected date
            jQuery.get("{{ url_for('parse_update') }}", 'page_id=' + $("#viewDateSelect").val()).fail(function () {
                alert("Error getting data for specified date! Please try again later.");
            }).done(function (data) {
                selectedDateCasesData = data;

                $("#selectedDate").text($("#viewDateSelect option:selected").text());

                // Generate geostats object for dataset
                let series = new geostats(Object.values(selectedDateCasesData));

                // Determine the classification type
                let classifierType = $("#dataClassificationMethodSelect").val();
                if (classifierType === "jenks") {
                    classes = series.getClassJenks(NUM_CLASSES);
                } else if (classifierType === "eqinterval") {
                    classes = series.getClassEqInterval(NUM_CLASSES);
                } else if (classifierType === "quantile") {
                    classes = series.getClassQuantile(NUM_CLASSES);
                } else {
                    // Default to jenks if something erroneous was entered
                    classes = series.getClassJenks(NUM_CLASSES);
                }

                // Initialize new shapefile layer
                shpFile = new L.Shapefile("{{ url_for('static', filename='bin/jordan_regions.shp.zip') }}", {
                    onEachFeature: function (feature, layer) {
                        // Get the number of COVID-19 cases for selected date
                        feature.properties['Number of Cases'] = selectedDateCasesData[feature.properties['RegionName']];

                        if (feature.properties) {
                            let popupString = Object.keys(feature.properties).map(function (k) {
                                return k + ": " + feature.properties[k];
                            }).join("<br />");

                            layer.bindPopup(popupString, {
                                maxHeight: 200
                            });
                        }
                    },
                    style: style
                });

                // Add layer to map
                shpFile.addTo(map);

                // Shapefile finished loading
                shpFile.once("data:loaded", function () {
                    console.log("Shapefile loaded");
                });

                // Create legend
                let legend = L.control({position: 'bottomright'});
                legend.onAdd = function () {
                    let legendDiv = L.DomUtil.create('div', 'info legend');
                    legendDiv.innerHTML += "<strong>Number of Cases</strong><br style='margin-bottom: 5px'>";

                    // Loop through all of the classes and populate the legend with them
                    for (let i = 0; i < classes.length; i++) {
                        legendDiv.innerHTML +=
                            '<i style="background:' + getColor(classes[i]) + '"></i> ' +
                            classes[i] + (classes[i + 1] ? '&ndash;' + classes[i + 1] + '<br>' : '+');
                    }

                    return legendDiv;
                };

                legend.addTo(map);
            });
        }

        /**
         * Generates a CSV file for the selected date's dateset
         */
        function downloadCSV() {
            let csv = 'Date,Region,NumCases\n';
            let timestamp = Date.parse($("#viewDateSelect option:selected").text());
            for (const item in selectedDateCasesData) {
                csv += `${timestamp},${item},${selectedDateCasesData[item]}\n`;
            }

            let date = new Date(timestamp);
            let hiddenElement = document.createElement('a');
            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            hiddenElement.target = '_blank';
            hiddenElement.download = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}-covid-19-cases.csv`;
            hiddenElement.click();
        }
    </script>
{% endblock %}